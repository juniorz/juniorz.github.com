
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Creating your own AMI - Reinaldo Junior</title>
  <meta name="author" content="Reinaldo Junior">

  
  <meta name="description" content="Disclaimer: this blog post is a DRAFT Objective Create a custom (and minimal) Centos 5.x instance store-backed AMI with
a traditional Amazon AKI/AMI &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.reinaldojunior.net/2013/03/05/creating-your-own-ami/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Reinaldo Junior" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4325461-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Reinaldo Junior</a></h1>
  
    <h2>Um outro tech-blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.reinaldojunior.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Creating your own AMI</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-05T17:46:00-03:00" pubdate data-updated="true">Mar 5<span>th</span>, 2013</time>
        

| <a href="http://prose.io/#juniorz/juniorz.github.com/edit/source/source/_posts/2013-03-05-creating-your-own-ami.markdown">Fork me</a>


        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>Disclaimer: this blog post is a DRAFT</strong></p>

<h2>Objective</h2>

<p>Create a custom (and minimal) Centos 5.x instance store-backed AMI with
a traditional Amazon AKI/AMI (no PVGrub).</p>

<h2>Context</h2>

<p>In order to launch a new machine, a user must choose a specific AMI (Amazon
Machine Image).</p>

<p>An AMI contains all information necessary to boot an Amazon EC2 instance with
your software. An AMI is like a template of a computer&#8217;s root volume.</p>

<p>Even though there is a lot of AMIs available (both publicly and privately),
often you just can&#8217;t find any that fits your needs (or you just can&#8217;t
trust what is shipped with the AMI).</p>

<p>Therefore, Amazon provides a way of creating (and distributing) your own AMIs,
giving you full control of what should be installed and running in your instance.</p>

<h2>Background</h2>

<p>In order to create a custom AMI you have to know a little about how it
work, what are the options available to be chosen and how to do it.</p>

<h3>The boot proccess</h3>

<p>Amazon EC2 is built on a Xen-based solution.
In order to launch a virtual machine (instance in EC2 nomenclature, domU in Xen
nomenclature) the Xen hypervisor needs some information about how to find the
proper kernel to boot, how to load it, and so on. This information is provided
by a set of shared files available in the EC2 infrastructure:</p>

<ul>
<li><p>An AKI (Amazon Kernel Image) is the Xen guest paravirtualized kernel used by an AMI.<br/>
It represents the <a href="http://en.wikipedia.org/wiki/Vmlinux">vmlinuz</a> portion of the kernel. It is basically the compiled
kernel that gets loaded on boot.</p></li>
<li><p>An ARI (Amazon Ramdisk Image) is the Xen guest paravirtualized ramdisk used by an AMI.<br/>
It represents the <a href="http://en.wikipedia.org/wiki/Initrd">initrd</a>/initramfs. It is the ramdisk that gets loaded with
the kernel and has the initial driver modules for the kernel to find the root
filesystem.</p></li>
</ul>


<p>When an AMI is built, it is designed for a specific AKI (and ARI).
Regarding the boot proccess, there are two ways of building an AMI:</p>

<ol>
<li>Using an AKI (and a corresponding ARI)</li>
<li>Using a PVGrub-based AKI (and no ARI)</li>
</ol>


<p>In the beginning of EC2, the only way to build an AMI was to use an AKI
(and a matching ARI) to boot the instance.</p>

<p>As from (date missing), EC2 started to support the use of PVGrub-based AKIs.
These AKIs simulate grub as the kernel and allow you to install your kernel on the
AMI and have it perform similar to bare-metal system where it reads the kernel
and ramdisk from the filesystem. These PVGrub AKIs do not use ARIs.</p>

<h3>Other AMI characteristics</h3>

<p>Besides the boot-specific setting you must craft your AMI according to the following characteristics:</p>

<p><strong>Root device volume</strong><br/>
Can be either <code>instance store</code> or <code>ebs</code>.
An <code>instance store</code> AMI can only launch <em>instance store-backed</em> instances
and an <code>ebs</code> AMI can only launch <em>ebs-backed</em> instances.</p>

<p><strong>Architecture</strong><br/>
Can be either <code>i386</code> (32-bits) or <code>x86_64</code> (64-bits).</p>

<h2>Building the AMI</h2>

<p>1) Launch a host instance on EC2
  - It will be easier and faster
2) Install the basic tollset
3) Get the kernel module matching the AKI/ARI
4) Install basic stuff
5) Bundle and publish</p>

<h3>Resources on the interwebs</h3>

<p>https://forums.aws.amazon.com/message.jspa?messageID=256534
https://help.ubuntu.com/community/EC2FAQ
http://openfoo.org/blog/amazon_ec2_underlying_architecture.html</p>

<p>http://en.wikipedia.org/wiki/Xen
http://en.wikipedia.org/wiki/Hypervisor</p>

<p>http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/RootDeviceStorage.html
http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/block-device-mapping-concepts.html</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Reinaldo Junior</span></span>

      








  


<time datetime="2013-03-05T17:46:00-03:00" pubdate data-updated="true">Mar 5<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aws/'>aws</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.reinaldojunior.net/2013/03/05/creating-your-own-ami/" data-via="ReinaldoJunior" data-counturl="http://blog.reinaldojunior.net/2013/03/05/creating-your-own-ami/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/01/05/migrando-o-blog-para-octopress/" title="Previous Post: Migrando o blog para Octopress">&laquo; Migrando o blog para Octopress</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <link href="http://blossom.github.com/contributors/example/contributors.css" media="screen, projection" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="http://blossom.github.com/contributors/lib/contributors.min.js"> </script>

<div id="blog-contributors"></div>
<script type="text/javascript">
  contributors.generate('brunch', 'brunch',
  { placeholder: 'blog-contributors'});
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/03/05/creating-your-own-ami/">Creating your own AMI</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/05/migrando-o-blog-para-octopress/">Migrando o blog para Octopress</a>
      </li>
    
      <li class="post">
        <a href="/2011/12/10/how-to-build-gstreamer-from-source/">How to build GStreamer from source</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/11/deploy-automatizado-de-aplicacoes-rails/">Deploy automatizado de aplicações Rails com Capistrano e Github</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/11/deploy-automatizado-de-aplicacoes-rails/">Deploy automatizado de aplicações Rails com Capistrano e Github</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/04/playing-with-droid/">Playing with Droid</a>
      </li>
    
      <li class="post">
        <a href="/2011/05/29/droid-dsl/">The Droid DSL</a>
      </li>
    
      <li class="post">
        <a href="/2011/05/15/xtext-editor-unexpectedly-stopped/">Xtext Editor unexpectedly stopped working</a>
      </li>
    
      <li class="post">
        <a href="/2011/04/26/o-que-e-o-google-summer-of-code/">O que é o Google Summer of Code?</a>
      </li>
    
      <li class="post">
        <a href="/2011/04/26/google-summer-of-code-2001-agora-e-pra/">Google Summer of Code 2011: Agora é pra valer</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/juniorz">@juniorz</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'juniorz',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ReinaldoJunior", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ReinaldoJunior" class="twitter-follow-button" data-show-count="false">Follow @ReinaldoJunior</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/juniorz?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/juniorz">My Delicious Bookmarks &raquo;</a></p>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/112706221039969915378?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Reinaldo Junior -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'reinaldojunior';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.reinaldojunior.net/2013/03/05/creating-your-own-ami/';
        var disqus_url = 'http://blog.reinaldojunior.net/2013/03/05/creating-your-own-ami/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
